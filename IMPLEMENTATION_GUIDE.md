# 新增功能实现指南

## 🎯 功能概述

本次更新为 AI 新闻聚合平台添加了以下功能：

### 1. 手动获取今日资讯 ✨
- **位置**: 文章页面的右上角
- **功能**: 点击"🔄 手动获取今日资讯"按钮，立即从所有启用的 RSS 源获取最新文章
- **流程**:
  - 调用 `/api/fetch-news` 端点
  - 并行获取所有 RSS 源
  - 自动去重、过滤、排序
  - 返回最新的文章列表

### 2. 文章日期分组显示 📅
- **位置**: 文章选择页面
- **功能**: 按发布日期自动分组显示文章，新日期优先显示
- **特性**:
  - 每个日期分组显示该日期的文章数量
  - 支持展开/折叠（可选）
  - 清晰的日期标签：`📅 2025年11月11日 (5 篇)`

### 3. 生成日报功能增强 🚀
- **位置**: "生成日报"标签页
- **功能**: 
  - 为每篇选中的文章生成 AI 摘要（基于 Gemini API）
  - 提取关键点
  - 生成美观的 HTML 日报
  - 自动发布到 GitHub Pages（可选）

### 4. 日报发布流程 📦
生成日报后的完整流程：
```
用户选择文章 → 点击"生成并发布日报"
  ↓
创建日报记录 (draft 状态)
  ↓
并行为每篇文章生成 AI 摘要
  ↓
生成 HTML 和 Markdown 版本
  ↓
更新日报为 published 状态
  ↓
异步发布到 GitHub Pages
  ↓
返回成功消息
```

### 5. 查看日报页面 📊
- **位置**: 新增"查看日报"标签页
- **功能**:
  - 显示所有已生成的日报（按日期倒序）
  - 显示每个日报的：
    - 生成日期
    - 发布状态（草稿/已发布）
    - 文章数量
    - 发布时间（如果已发布）
  - 点击"查看日报"按钮打开 HTML 版本

## 🔧 技术实现细节

### 新增 API 端点

#### 1. POST /api/fetch-news
**功能**: 手动触发获取今日资讯

**请求**:
```json
POST /api/fetch-news
```

**响应**:
```json
{
  "success": true,
  "message": "成功获取 15 篇新文章",
  "count": 15,
  "articles": [...]  // 前10篇预览
}
```

**实现**:
- 获取所有启用的 RSS 源
- 并行调用 `fetchRSSFeed()` 获取文章
- 通过 `processArticles()` 处理（去重、过滤、排序）
- 通过 `addArticles()` 存储到数据库

#### 2. POST /api/reports (增强)
**功能**: 创建日报并触发 AI 摘要生成

**请求**:
```json
{
  "date": "2025-11-11T00:00:00Z",
  "selectedArticles": ["article-id-1", "article-id-2", ...]
}
```

**响应**:
```json
{
  "id": "report-id",
  "date": "2025-11-11",
  "selectedArticles": [...],
  "summary": "包含 5 篇精选文章",
  "generatedHtml": "<html>...</html>",
  "status": "published",
  "publishedAt": "2025-11-11T10:30:00Z"
}
```

**实现步骤**:
1. 验证选中的文章数量（1-10篇）
2. 创建日报记录（初始状态为 draft）
3. 为每篇文章并行生成 AI 摘要
4. 生成 HTML 和 Markdown 版本
5. 更新日报为 published 状态
6. 异步发布到 GitHub Pages

### 文件变更

#### 新增文件:
1. `apps/api/routes/fetch-news.ts` - 手动获取资讯端点
2. `packages/fetchers/index.ts` - fetchers 包导出

#### 修改文件:
1. `apps/web/pages/index.tsx` - 前端 UI 完全重写
   - 添加手动获取按钮
   - 添加文章日期分组逻辑
   - 添加查看日报页面
   - 改进样式和交互

2. `apps/api/routes/reports.ts` - 报告端点增强
   - 添加 AI 摘要生成逻辑
   - 添加 GitHub Pages 发布功能
   - 改进错误处理

3. `.env.example` - 环境变量模板
   - 移除泄露的真实密钥
   - 添加清晰的配置说明

## 🚀 使用流程

### 第一步：添加 RSS 源
1. 点击"📰 信息源"标签
2. 填写源名称、RSS 链接、分类
3. 点击"添加"按钮
4. 源添加成功后会立即显示在表格中

### 第二步：获取最新资讯
1. 点击"📄 文章"标签
2. 点击右上角的"🔄 手动获取今日资讯"按钮
3. 等待加载完成（通常 5-10 秒）
4. 系统会显示获取的文章数量

### 第三步：选择文章
1. 文章按发布日期分组显示
2. 每组显示文章数量
3. 勾选最多 10 篇感兴趣的文章
4. 已选择的文章会高亮显示

### 第四步：生成日报
1. 点击"✨ 生成日报"标签
2. 确认选中的文章数量
3. 点击"🚀 生成并发布日报"按钮
4. 系统会：
   - 为每篇文章生成 AI 摘要
   - 生成漂亮的 HTML 日报
   - 自动发布到 GitHub Pages（如果配置了）
   - 显示成功提示

### 第五步：查看日报
1. 点击"📊 查看日报"标签
2. 查看所有已生成的日报列表
3. 点击"📖 查看日报"按钮查看详细内容
4. 日报会在新标签页打开

## 🎨 前端 UI 改进

### 布局变化
- 文章页面添加顶部工具栏（手动获取按钮）
- 文章列表按日期分组显示
- 每个文章卡片包含：
  - 标题（可点击原文链接）
  - 描述摘要
  - 来源标签
  - 阅读原文链接

### 交互改进
- 勾选最多 10 篇文章时有警告提示
- 生成日报时禁用按钮防止重复提交
- 实时显示已选择文章数量
- 加载状态显示

## 🔐 安全性考虑

### API 调用
- 使用 `async/await` 处理异步操作
- 添加错误捕获和日志记录
- 对用户输入进行验证（文章数量限制）

### GitHub 发布
- 使用个人访问令牌（不存储密码）
- Token 存储在环境变量中
- 发布失败不影响日报生成

### AI 调用
- 仅在配置了 API Key 时调用
- 失败时继续进行（降级处理）
- 并行调用时的错误隔离

## 📊 性能优化

1. **并行处理**:
   - 多个 RSS 源并行获取
   - 多篇文章并行生成摘要

2. **异步操作**:
   - GitHub 发布在后台进行
   - 不阻塞用户交互

3. **数据处理**:
   - 前端分组（避免不必要的排序）
   - 数据库查询带索引

## 🐛 常见问题排查

### 手动获取没有返回文章
1. 检查是否添加了 RSS 源
2. 检查浏览器控制台错误
3. 检查 RSS 源是否有效
4. 查看服务器日志

### AI 摘要没有生成
1. 检查 `.env.local` 中的 `GEMINI_API_KEY`
2. 检查 Gemini API 配额是否超限
3. 查看服务器日志中的错误信息
4. 摘要生成是可选的，不会影响日报生成

### GitHub 发布失败
1. 检查 `GITHUB_TOKEN` 是否有效
2. 检查 Token 是否有 `repo` 权限
3. 检查 `GITHUB_OWNER` 和 `GITHUB_REPO` 是否正确
4. GitHub 发布是可选的，不会影响日报生成

## 📝 下一步改进

- [ ] 支持文章搜索和筛选
- [ ] 支持自定义 AI 摘要长度
- [ ] 支持多种日报主题和样式
- [ ] 支持邮件发送日报
- [ ] 支持 Webhook 通知
- [ ] 添加阅读时间估计
- [ ] 支持文章收藏和标记
- [ ] 支持用户登录和偏好设置

